<group name="audit,windows,">

    <!-- Local rules -->

    <!-- Wazuh section -->

    <!-- Overwrite section-->

    <!-- File rotation/reducded rules -->

    <rule id="204" level="9" overwrite="yes">
        <if_sid>201</if_sid>
        <field name="level">flooded</field>
        <description>Agent event queue is flooded. Check the agent configuration.</description>
        <group>agent_flooding,gdpr_IV_35.7.d,</group>
    </rule>

    <rule id="203" level="10" overwrite="yes">
        <field name="level">full</field>
        <if_sid>201</if_sid>
        <description>Agent event queue is full. Events may be lost.</description>
        <group>agent_flooding,gdpr_IV_35.7.d,</group>
    </rule>

    <rule id="504" level="10" overwrite="yes">
        <if_sid>500</if_sid>
        <options>alert_by_email</options>
        <match>Agent disconnected</match>
        <description>Ossec agent disconnected.</description>
        <group>pci_dss_10.6.1,pci_dss_10.2.6,gpg13_10.1,gdpr_IV_35.7.d,</group>
    </rule>

    <!-- <rule id="505" level="10" overwrite="yes">
        <if_sid>500</if_sid>
        <options>alert_by_email</options>
        <match>Agent removed</match>
        <description>Ossec agent removed.</description>
        <group>pci_dss_10.6.1,pci_dss_10.2.6,gpg13_10.1,gdpr_IV_35.7.d,</group>
    </rule> -->

    <rule id="591" level="0" overwrite="yes">
        <if_sid>500</if_sid>
        <match>^ossec: File rotated </match>
        <description>Log file rotated.</description>
        <group>pci_dss_10.5.2,pci_dss_10.5.5,gpg13_10.1,gdpr_II_5.1.f,gdpr_IV_35.7.d,</group>
    </rule>

    <rule id="2504" level="10" overwrite="yes">
        <match>ILLEGAL ROOT LOGIN|ROOT LOGIN REFUSED</match>
        <description>syslog: Illegal root login.</description>
        <group>invalid_login,pci_dss_10.2.4,pci_dss_10.2.5,pci_dss_10.2.2,gpg13_7.8,gdpr_IV_35.7.d,gdpr_IV_32.2,</group>
    </rule>

    <rule id="2960" level="10" overwrite="yes">
        <decoded_as>gpasswd</decoded_as>
        <match>added by</match>
        <description>User added to group.</description>
        <group>gpg13_7.9,gpg13_4.13,gdpr_IV_32.2,</group>
    </rule>

    <rule id="2961" level="10" overwrite="yes">
        <if_sid></if_sid>
        <field name="group">sudo</field>
        <description>User added to group sudo.</description>
        <group>gpg13_7.9,gpg13_4.13,gdpr_IV_32.2,</group>
    </rule>

    <rule id="5103" level="10" overwrite="yes">
        <if_sid>5100</if_sid>
        <match>Oversized packet received from</match>
        <description>Error message from the kernel.</description>
        <description>Ping of death attack.</description>
        <group>gdpr_IV_35.7.d,</group>
    </rule>

    <rule id="5302" level="10" overwrite="yes">
        <if_sid>5301</if_sid>
        <user>^root</user>
        <description>User missed the password to change UID to root.</description>
        <group>authentication_failed,pci_dss_10.2.4,pci_dss_10.2.5,gpg13_7.8,gdpr_IV_35.7.d,gdpr_IV_32.2,</group>
    </rule>

    <rule id="5305" level="0" overwrite="yes">
        <if_sid>5303, 5304</if_sid>
        <if_fts></if_fts>
        <options>alert_by_email</options>
        <description>First time (su) is executed by user.</description>
    </rule>

    <rule id="5402" level="0" overwrite="yes">
        <if_sid>5400</if_sid>
        <regex> ; USER=root ; COMMAND=| ; USER=root ; TSID=\S+ ; COMMAND=</regex>
        <description>Successful sudo to ROOT executed</description>
        <group>pci_dss_10.2.5,pci_dss_10.2.2,gpg13_7.6,gpg13_7.8,gpg13_7.13,gdpr_IV_32.2,</group>
    </rule>

    <rule id="5403" level="0" overwrite="yes">
        <if_sid>5400</if_sid>
        <options>alert_by_email</options>
        <if_fts></if_fts>
        <description>First time user executed sudo.</description>
    </rule>

    <rule id="5501" level="5" overwrite="yes">
        <if_sid>5500</if_sid>
        <match>session opened for user </match>
        <description>PAM: Login session opened.</description>
        <group>authentication_success,pci_dss_10.2.5,gpg13_7.8,gpg13_7.9,gdpr_IV_32.2,</group>
    </rule>

    <rule id="5502" level="0" overwrite="yes">
        <if_sid>5500</if_sid>
        <match>session closed for user </match>
        <description>PAM: Login session closed.</description>
        <group>pci_dss_10.2.5,gpg13_7.8,gpg13_7.9,gdpr_IV_32.2,</group>
    </rule>

    <rule id="5702" level="11" overwrite="yes">
        <if_sid>5700</if_sid>
        <match>^reverse mapping</match>
        <regex>failed - POSSIBLE BREAK</regex>
        <description>sshd: Reverse lookup error (bad ISP or attack).</description>
        <group>pci_dss_11.4,gpg13_4.12,gdpr_IV_35.7.d,</group>
    </rule>

    <rule id="5706" level="0" overwrite="yes">
        <if_sid>5700</if_sid>
        <match>Did not receive identification string from</match>
        <description>sshd: insecure connection attempt (scan).</description>
        <group>recon,pci_dss_11.4,gpg13_4.12,gdpr_IV_35.7.d,</group>
    </rule>

    <rule id="5707" level="14" overwrite="yes">
        <if_sid>5700</if_sid>
        <match>fatal: buffer_get_string: bad string</match>
        <description>sshd: OpenSSH challenge-response exploit.</description>
        <group>exploit_attempt,pci_dss_11.4,pci_dss_6.2,gpg13_4.12,gdpr_IV_35.7.d,</group>
    </rule>

    <rule id="5718" level="11" overwrite="yes">
        <if_sid>5700</if_sid>
        <match>not allowed because</match>
        <description>sshd: Attempt to login using a denied user.</description>
        <group>invalid_login,pci_dss_10.2.4,pci_dss_10.2.5,gpg13_7.1,gdpr_IV_35.7.d,gdpr_IV_32.2,</group>
    </rule>

    <rule id="5731" level="10" overwrite="yes">
        <if_sid>5700</if_sid>
        <match>AKASSH_Version_Mapper1.</match>
        <description>sshd: SSH Scanning.</description>
        <group>recon,pci_dss_11.4,gdpr_IV_35.7.d,</group>
    </rule>

    <rule id="5733" level="10" overwrite="yes">
        <if_sid>5700</if_sid>
        <match>Invalid credentials</match>
        <description>sshd: User entered incorrect password.</description>
        <group>authentication_failures,pci_dss_10.2.4,pci_dss_10.2.5,gpg13_7.1,gdpr_IV_35.7.d,gdpr_IV_32.2,</group>
    </rule>

    <!-- Agregamos respectivos program name useradd y groupadd, ya que cuando se agrega un grupo con useradd tira error
    ej: Oct  8 13:26:57 af-rec-mongo-shard-00 useradd[1751]: new group: name=dbmanager, GID=1042-->

    <rule id="5902" level="10" overwrite="yes">
        <match>^new user|^new account added</match>
        <description>New user (unknown) added to the system.</description>
        <group>pci_dss_10.2.7,pci_dss_10.2.5,pci_dss_8.1.2,gpg13_4.13,gdpr_IV_35.7.d,gdpr_IV_32.2,hipaa_164.312.b,hipaa_164.312.a.2.I,hipaa_164.312.a.2.II,nist_800_53_AU.14,nist_800_53_AC.7,nist_800_53_AC.2,nist_800_53_IA.4,</group>
    </rule>

    <rule id="5903" level="10" overwrite="yes">
        <match>^delete user|^account deleted|^remove group</match>
        <description>Group (or user) (unknown) deleted from the system</description>
        <group>pci_dss_10.2.7,pci_dss_10.2.5,pci_dss_8.1.2,gpg13_4.13,gdpr_IV_35.7.d,gdpr_IV_32.2,</group>
    </rule>

    <rule id="5904" level="10" overwrite="yes">
        <match>^changed user</match>
        <description>Information from the user was changed</description>
        <group>pci_dss_10.2.7,pci_dss_10.2.5,pci_dss_8.1.2,gpg13_4.13,gdpr_IV_35.7.d,gdpr_IV_32.2,</group>
    </rule>

    <rule id="5905" level="10" overwrite="yes">
        <program_name>useradd</program_name>
        <match>failed adding user </match>
        <description>useradd failed.</description>
    </rule>

    <rule id="30109" level="10" overwrite="yes">
        <if_sid>30101</if_sid>
        <regex>user \S+ not found|user \S+ in realm \.* not found</regex>
        <description>Apache Attempt to login using a nonexistent user.</description>
        <group>invalid_login,pci_dss_10.2.4,pci_dss_10.2.5,gpg13_7.1,gdpr_IV_35.7.d,gdpr_IV_32.2,</group>
    </rule>

    <rule id="50106" level="10" overwrite="yes">
        <if_sid>50105</if_sid>
        <match>Access denied for user</match>
        <description>MySQL authentication failure.</description>
        <group>authentication_failed,pci_dss_10.2.4,pci_dss_10.2.5,pci_dss_8.7,gpg13_7.1,gdpr_IV_35.7.d,gdpr_IV_32.2,</group>
    </rule>

    <rule id="50512" level="10" overwrite="yes">
        <if_sid>50504</if_sid>
        <match>authentication failed</match>
        <description>PostgreSQL: Database authentication failure.</description>
        <group>authentication_failed,pci_dss_10.2.4,pci_dss_10.2.5,gpg13_7.1,gdpr_IV_35.7.d,gdpr_IV_32.2,</group>
    </rule>

    <rule id="80710" level="0" overwrite="yes">
        <if_sid>80700</if_sid>
        <field name="audit.type">ANOM_PROMISCUOUS</field>
        <match>prom=256</match>
        <description>Auditd: device enables promiscuous mode</description>
        <group>audit_anom,pci_dss_11.4,pci_dss_10.6.1,gpg13_4.14,gdpr_IV_35.7.d,gdpr_IV_30.1.g,hipaa_164.312.b,nist_800_53_SI.4,nist_800_53_AU.6,</group>
    </rule>

    <rule id="80711" level="9" overwrite="yes">
        <if_sid>80700</if_sid>
        <field name="audit.type">ANOM_ABEND</field>
        <description>Auditd: process ended abnormally</description>
        <group>audit_anom,pci_dss_11.4,pci_dss_10.6.1,gpg13_4.14,gdpr_IV_35.7.d,gdpr_IV_30.1.g,</group>
    </rule>

    <rule id="80730" level="0" overwrite="yes">
        <if_sid>80700</if_sid>
        <field name="audit.type">AVC</field>
        <description>Auditd: SELinux permission check</description>
        <group>audit_selinux,pci_dss_10.6.1,gdpr_IV_35.7.d,gdpr_IV_30.1.g,</group>
    </rule>

    <rule id="85751" level="10" overwrite="yes">
        <if_sid>85750</if_sid>
        <field name="mongodb.severity">F</field>
        <description>MongoDB: Fatal message</description>
        <group>gdpr_IV_35.7.d,</group>
    </rule>

    <rule id="88003" level="10" overwrite="yes">
        <if_sid>88000</if_sid>
        <field name="audit_record.name">^Connect$</field>
        <field name="audit_record.status">^1</field>
        <description>Percona audit: authentication failure.</description>
        <group>authentication_failed,pci_dss_10.2.4,pci_dss_10.2.5,pci_dss_8.7,gpg13_7.1,gdpr_IV_35.7.d,gdpr_IV_32.2,</group>
    </rule>

    <rule id="60103" level="1" overwrite="yes">
        <if_sid>60001</if_sid>
        <field name="win.system.severityValue">^AUDIT_SUCCESS$|^success$</field>
        <description>Windows audit success event</description>
        <options>no_full_log</options>
    </rule>

    <!-- Windows section -->

    <!-- Windows  audit section -->

    <!-- low: rule ID between 101000 and 101999 -->

    <!-- high: rule ID between 102000 and 102999 -->

    <!-- Windows Command Line Auditing -->

    <rule id="101000" level="8">
        <if_sid>60103</if_sid>
        <field name="win.system.severityValue">^AUDIT_SUCCESS$|^success$</field>
        <field name="win.system.eventID">^4688$</field>
        <description>New process creation</description>
        <options>no_full_log</options>
    </rule>

    <rule id="102000" level="8">
        <if_sid>101000</if_sid>
        <field name="win.eventdata.parentProcessName">cmd.exe|powershell.exe</field>
        <description>New process creation (user, interactive, high priority)</description>
        <options>no_full_log</options>
    </rule>

    <rule id="101001" level="8">
        <if_sid>102000</if_sid>
        <field name="win.eventdata.subjectUserName">\.*\$</field>
        <description>New process creation (system, low priority)</description>
        <options>no_full_log</options>
    </rule>

    <rule id="101002" level="8">
        <if_sid>60103</if_sid>
        <field name="win.system.eventID">^4624$</field>
        <description>Login event (low priority)</description>
        <options>no_full_log</options>
    </rule>

    <rule id="102001" level="8">
        <if_sid>101002</if_sid>
        <field name="win.eventdata.authenticationPackageName">Negotiate</field>
        <field name="win.eventdata.logonType">10</field>
        <description>Interactive high priority login (RDP)</description>
        <options>no_full_log</options>
    </rule>

    <rule id="102002" level="8">
        <if_sid>60109</if_sid>
        <!-- <field name="win.system.eventID">^624$|^626$|^4720$|^4722$</field> -->
        <description>User account enabled or created</description>
    </rule>

    <rule id="101003" level="8">
        <if_sid>60110</if_sid>
        <!-- <field name="win.system.eventID">^628$|^642$|^685$|^4738$|^4781$</field> -->
        <description>User account changed</description>
    </rule>

    <rule id="102003" level="8">
        <if_sid>60111</if_sid>
        <description>User account disabled or deleted</description>
    </rule>

  <rule id="101004" level="5">
    <if_sid>60122</if_sid>
    <!-- <field name="win.system.eventID">^529$|^4625$</field> -->
    <description>Logon Failure - Unknown user or bad password</description>
  </rule>

  <rule id="102004" level="5">
    <if_sid>60123</if_sid>
    <!-- <field name="win.system.eventID">^530$</field> -->
    <description>Logon Failure - Account logon time restriction violation</description>
  </rule>

  <rule id="102005" level="5">
    <if_sid>60124</if_sid>
    <!-- <field name="win.system.eventID">^531$</field> -->
    <description>Logon Failure - Account currently disabled</description>
  </rule>

  <rule id="102006" level="5">
    <if_sid>60125</if_sid>
    <!-- <field name="win.system.eventID">^532$</field> -->
    <description>Logon Failure - Specified account expired</description>
  </rule>

  <rule id="102007" level="7">
    <if_sid>60126</if_sid>
    <!-- <field name="win.system.eventID">^533$</field> -->
    <description>Logon Failure - User not allowed to login at this computer</description>
  </rule>

  <rule id="102008" level="5">
    <if_sid>60127</if_sid>
    <!-- <field name="win.system.eventID">^534$</field> -->
    <description>Logon Failure - User not granted logon type</description>
  </rule>

  <rule id="102009" level="5">
    <if_sid>60128</if_sid>
    <!-- <field name="win.system.eventID">^535$</field> -->
    <description>Logon Failure - Account's password expired</description>
  </rule>

  <rule id="102010" level="5">
    <if_sid>60129</if_sid>
    <!-- <field name="win.system.eventID">^536$|^537$</field> -->
    <description>Logon Failure - Internal error</description>
  </rule>

  <rule id="102011" level="7">
    <if_sid>60130</if_sid>
    <!-- <field name="win.system.eventID">^539$</field> -->
    <description>Logon Failure - Account locked out</description>
  </rule>

  <rule id="102012" level="5">
    <if_sid>60131</if_sid>
    <!-- <field name="win.system.eventID">^673$|^675$|^681$|^4769$</field> -->
    <description>Windows DC Logon Failure</description>
  </rule>

  <rule id="102013" level="5">
    <if_sid>60133</if_sid>
    <!-- <field name="win.system.eventID">^671$|^4767$</field> -->
    <description>User account unlocked</description>
  </rule>

  <rule id="102014" level="5">
    <if_sid>101002</if_sid>                                                                                                                                     
    <field name="win.eventdata.authenticationPackageName">NTLM</field>
    <description>Succesful interactive account login</description>
  </rule>

    <rule id="102015" level="5">
        <if_sid>101004</if_sid>
        <!-- <field name="win.system.eventID">^529$|^4625$</field> -->
        <field name="win.eventdata.authenticationPackageName">NTLM</field>
        <description>Interactive Logon Failure</description>
    </rule>

  <!-- <rule id="102015" level="6" frequency="2" timeframe="5">
    <if_matched_sid>102014</if_matched_sid>
    <field name="win.eventdata.authenticationPackageName">NTLM</field>
    <description>Succesful interactive account login (summarized alert)</description>
  </rule> -->

    <!-- Windows critical section -->
    <!-- Rule ID between 103000 and 103999 -->

  <rule id="103000" level="10" >
      <if_sid>60204</if_sid>
      <description>Multiple Interactive Windows Logon Failures (critical)</description>
      <field name="data.win.eventdata.targetUserName">\.+</field>
  </rule>

  <rule id="103002" level="0">
    <if_sid>102015</if_sid>
    <!-- <field name="win.system.eventID">^529$|^4625$</field> -->
    <field name="win.eventdata.targetUserName">\.*\$</field>
    <description>Interactive Logon Failure (muted)</description>
  </rule>

    <rule id="103003" level="11" ignore="2">
        <if_sid>101000</if_sid>
        <field name="win.eventdata.newProcessName">cmd.exe|powershell.exe</field>
        <field name="win.eventdata.parentProcessName">WmiPrvSE.exe</field>
        <description>wmiexec.py detected (critical usage)</description>
        <options>no_full_log</options>
    </rule>

    <rule id="103004" level="11" frequency="3" timeframe="60">                                                                                     
        <if_matched_sid>102015</if_matched_sid> 
        <same_field>win.eventdata.ipAddress</same_field>                                                                                                                
        <description>ntlmAuth: brute force trying to get access to the system. </description>                                                                                   
    </rule>

    <!-- Windows custom section -->

    <!-- Rule ID between 104000 and 104999 -->

    <!-- Linux section -->

    <!-- Linux audit section -->

    <!-- low: rule ID between 105000 and 105999 -->

    <!-- high: rule ID between 106000 and 106999 -->

    <!--
    Resumen de los eventos monitoreados:

    Evento de login por ssh NATIVO (de authlog) de los siguientes usuarios -> audit:
    despegar
    munin-async
    masterchef
    cloudcli
    sox
    device42
    dbmanager
    logger

    Evento de login por ssh NATIVO (de authlog) del usuario root, desde las siguientes ips -> audit:
    10.12.13.75
    10.70.0.5
    10.70.0.6
    10.12.5.160
    10.12.12.207
    10.172.23.113
    10.1.5.48
    10.1.5.49
    10.1.5.50
    10.1.5.51
    10.70.135.71
    10.12.10.207

    Cualquier otro evento de login por ssh NATIVO -> audit-high

    Cualquier comando ejecutado sin tty asociada (no interactivo) -> audit

    Cualquier comando ejecutado con tty asociada (no interactivo) -> audit

    Cualquier modificacion de archivo que no sea de contenido -> new-wazuh-alerts (se descarta en el dia)

    Cualquier modificacion de contenido de archivo -> audit-high
    -->

    <!-- Como no se puede negar en un campo custom, mandamos todas las alertas de comandos a high (104000), y buscamos las que tienen tty en none y las bajamos de prioridad (102015)-->

    <rule id="106000" level="9">
        <if_sid>80792</if_sid>
        <field name="audit.tty">\.+</field>
        <description>Interactive command with associated tty.</description>
    </rule>

    <!-- Como no existe el operador AND, ponemos todos los logins en alta prioridad (104001) y despues matcheamos cualquiera de los usuarios de baja prioridad y los bajamos a baja prioridad (103002)-->

    <!-- <rule id="106001" level="9">
        <if_sid>5715</if_sid>
        <description>High priority linux login audit event</description>
    </rule> -->

    <rule id="105001" level="9">
        <if_sid>106000</if_sid>
        <field name="audit.tty">(none)</field>
        <description>Command without asociated tty.</description>
    </rule>

        <!-- <user>despegar|munin-async|masterchef|logger|cloudcli|sox|device42|dbmanager</user> -->

    <!-- <rule id="105002" level="9">
        <if_sid>106001</if_sid>
        <list field="user" lookup="match_key">etc/lists/ignoredLoginUsers</list>
        <description>Low priority linux logins audit events.</description>
    </rule> -->

    <!-- Debido a la regla 106001, todos los logins de root son alta prioridad, EXCEPTO los de ips whitelisteadas-->
        <!-- <list field="srcip" lookup="address_match_key">etc/lists/allowedRootLoginIps</list> -->

    <!-- <rule id="105003" level="9">
        <if_sid>106001</if_sid>
        <user>root</user>
        <srcip>10.12.13.75</srcip>
        <srcip>10.70.0.5</srcip>
        <srcip>10.70.0.6</srcip>
        <srcip>10.12.5.160</srcip>
        <srcip>10.12.12.207</srcip>
        <srcip>10.172.23.113</srcip>
        <srcip>10.1.5.48</srcip>
        <srcip>10.1.5.49</srcip>
        <srcip>10.1.5.50</srcip>
        <srcip>10.1.5.51</srcip>
        <srcip>10.70.135.71</srcip>
        <srcip>10.12.10.207</srcip>
        <description>Low priority linux root login audit event (whitelisted IP)</description>
    </rule> -->

    <rule id="105004" level="7">
        <if_sid>5904</if_sid>
        <list field="user" lookup="match_key">etc/lists/serviceAndSysadminAccounts</list>
        <description>Information from the user was changed</description>
        <group>pci_dss_10.2.7,pci_dss_10.2.5,pci_dss_8.1.2,gpg13_4.13,gdpr_IV_35.7.d,gdpr_IV_32.2,</group>
    </rule>

    <rule id="105005" level="7">
        <if_sid>2960</if_sid>
        <list field="user" lookup="match_key">etc/lists/serviceAndSysadminAccounts</list>
        <description>User added to group</description>
        <group>pci_dss_10.2.7,pci_dss_10.2.5,pci_dss_8.1.2,gpg13_4.13,gdpr_IV_35.7.d,gdpr_IV_32.2,</group>
    </rule>

    <rule id="105006" level="7">
        <if_sid>5304</if_sid>
        <list field="user" lookup="match_key">etc/lists/serviceAndSysadminAccounts</list>
        <description>User successfully changed UID.</description>
        <group>pci_dss_10.2.7,pci_dss_10.2.5,pci_dss_8.1.2,gpg13_4.13,gdpr_IV_35.7.d,gdpr_IV_32.2,</group>
    </rule>

    <rule id="105008" level="7">
        <if_sid>5902</if_sid>
        <list field="user" lookup="match_key">etc/lists/serviceAndSysadminAccounts</list>
        <description>New user (known) added to the system</description>
        <group>pci_dss_10.2.7,pci_dss_10.2.5,pci_dss_8.1.2,gpg13_4.13,gdpr_IV_35.7.d,gdpr_IV_32.2,</group>
    </rule>

    <rule id="105009" level="7">
        <if_sid>5903</if_sid>
        <list field="user" lookup="match_key">etc/lists/serviceAndSysadminAccounts</list>
        <description>Group (or user) (known) deleted from the system</description>
        <group>pci_dss_10.2.7,pci_dss_10.2.5,pci_dss_8.1.2,gpg13_4.13,gdpr_IV_35.7.d,gdpr_IV_32.2,</group>
    </rule>

    <rule id="105011" level="4">
        <if_sid>5304</if_sid>
        <regex>session opened for user|succeeded for|</regex>
        <regex>^+|^\S+ to |^SU \S+ \S+ + </regex>
        <description>User successfully changed UID.</description>
        <group>authentication_success,pci_dss_10.2.5,gpg13_7.6,gpg13_7.8,gdpr_IV_35.7.d,gdpr_IV_32.2,</group>
    </rule>

    <rule id="105012" level="9">
        <if_sid>106000</if_sid>
        <field name="audit.exe">/usr/bin/env|/usr/bin/dircolors|/bin/hostname|/usr/bin/locale</field>
        <description>Common interactive command (low priority).</description>
    </rule>

    <rule id="105013" level="9">
        <if_sid>106000</if_sid>
        <field name="audit.exe">/bin/ls</field>
        <field name="audit.execve.a0">ls</field>
        <field name="audit.execve.a1">--color=auto</field>
        <description>Common interactive command (low priority).</description>
    </rule>

    <rule id="106002" level="9">
        <if_sid>5710</if_sid>
        <description>Invalid user login</description>
    </rule>

    <rule id="106003" level="9">
        <decoded_as>session-logger</decoded_as>
        <description>Audit: new SSH session</description>
    </rule>

    <rule id="106005" level="9">
        <if_sid>550</if_sid>
        <match>Old sha256sum was</match>
        <description>File contents changed</description>
    </rule>

    <rule id="106006" level="9">
        <if_sid>553</if_sid>
        <description>File deleted.</description>
    </rule>

    <rule id="106007" level="9">
        <if_sid>554</if_sid>
        <description>File added to the system.</description>
    </rule>

    <rule id="106008" level="7">
        <if_sid>505</if_sid>
        <description>Ossec agent removed.</description>
    </rule>

    <rule id="105014" level="9">
        <if_sid>106003</if_sid>
        <!-- <list field="audit.real_user" lookup="match_key">etc/lists/ignoredLoginUsers</list> -->
        <field name="audit.cloudia_user">desplegar|nagios|vault-manager|cloudia_deploy</field>
        <description>Low priority linux login (ignored cloudia source user).</description>
    </rule>

    <rule id="105015" level="9">
        <if_sid>106003</if_sid>
        <!-- <list field="audit.real_user" lookup="match_key">etc/lists/ignoredLoginUsers</list> -->
        <!-- <user>despegar|munin-async|masterchef|logger|cloudcli|sox|device42|dbmanager</user> -->
        <field name="audit.real_user">munin-async|dbmanager|cloudcli|masterchef|nova</field>
        <description>Low priority linux login (ignored real destination user).</description>
    </rule>

    <rule id="105016" level="9">
        <if_sid>106003</if_sid>
        <!-- <list field="audit.real_user" lookup="match_key">etc/lists/ignoredLoginUsers</list> -->
        <!-- <user>despegar|munin-async|masterchef|logger|cloudcli|sox|device42|dbmanager</user> -->
        <field name="audit.real_user">despegar</field>
        <field name="audit.cloudia_user">-</field>
        <description>Low priority linux login (despegar login without cloudia user (group login)).</description>
    </rule>

    <rule id="105017" level="9">
        <if_sid>106003</if_sid>
        <field name="audit.real_user">root</field>
        <!-- <list field="srcip" lookup="address_match_key">etc/lists/allowedRootLoginIps</list> -->
        <srcip>10.12.13.75</srcip>
        <srcip>10.70.0.5</srcip>
        <srcip>10.70.0.6</srcip>
        <srcip>10.12.5.160</srcip>
        <srcip>10.12.12.207</srcip>
        <srcip>10.172.23.113</srcip>
        <srcip>10.1.5.48</srcip>
        <srcip>10.1.5.49</srcip>
        <srcip>10.1.5.50</srcip>
        <srcip>10.1.5.51</srcip>
        <srcip>10.70.135.71</srcip>
        <srcip>10.12.10.207</srcip>
        <description>Low priority linux root login audit event (whitelisted IP)</description>
    </rule>

    <rule id="106009" level="3">
        <if_sid>501</if_sid>
        <description>New ossec agent connected.</description>
    </rule>

    <rule id="106010" level="3">
        <if_sid>502</if_sid>
        <description>Ossec server started.</description>
    </rule>

    <rule id="106011" level="3">
        <if_sid>503</if_sid>
        <description>Ossec agent started.</description>
    </rule>

    <!-- Linux critical section -->

    <!-- Rule ID between 107000 and 107999 -->

    <!-- INICIO DE REGLAS SIN PARAMETROS  -->

    <rule id="107005" level="14">
        <if_sid>80792</if_sid>
        <field name="audit.type">SYSCALL</field>
        <regex>"\.*masscan\.*"</regex>
        <description>Possible malicious command executed (masscan).</description>
        <group>maliciouscommands</group>
    </rule>

    <rule id="107006" level="14">
        <if_sid>80792</if_sid>
        <field name="audit.type">SYSCALL</field>
        <regex>"\.*ldapdomaindump\.*"</regex>
        <description>Possible malicious command executed (ldapdomaindump).</description>
        <group>maliciouscommands</group>
    </rule>

    <rule id="107007" level="14">
        <if_sid>80792</if_sid>
        <field name="audit.type">SYSCALL</field>
        <regex>"\.*gobuster\.*"</regex>
        <description>Possible malicious command executed (gobuster).</description>
        <group>maliciouscommands</group>
    </rule>

    <rule id="107008" level="14">
        <if_sid>80792</if_sid>
        <field name="audit.type">SYSCALL</field>
        <regex>"\.*sqlmap\.*"</regex>
        <description>Possible malicious command executed (sqlmap).</description>
        <group>maliciouscommands</group>
    </rule>

    <rule id="107009" level="14">
        <if_sid>80792</if_sid>
        <field name="audit.type">SYSCALL</field>
        <regex>"\.*crackmapexec\.*"</regex>
        <description>Possible malicious command executed (crackmapexec).</description>
        <group>maliciouscommands</group>
    </rule>

    <rule id="107011" level="14">
        <if_sid>80792</if_sid>
        <field name="audit.type">SYSCALL</field>
        <regex>"\.*smbmap\.*"</regex>
        <description>Possible malicious command executed (smbmap).</description>
        <group>maliciouscommands</group>
    </rule>

    <rule id="107012" level="14">
        <if_sid>80792</if_sid>
        <field name="audit.type">SYSCALL</field>
        <regex>"\.*ntlmrelayx\.*"</regex>
        <description>Possible malicious command executed (ntlmrelayx.py).</description>
        <group>maliciouscommands</group>
    </rule>

    <rule id="107013" level="14">
        <if_sid>80792</if_sid>
        <field name="audit.type">SYSCALL</field>
        <regex>"\.*impacket\.*"</regex>
        <description>Possible malicious command executed (impacket).</description>
        <group>maliciouscommands</group>
    </rule>

    <rule id="107014" level="14">
        <if_sid>80792</if_sid>
        <field name="audit.type">SYSCALL</field>
        <regex>"\.*smbrelayx\.*"</regex>
        <description>Possible malicious command executed (smbrelayx.py).</description>
        <group>maliciouscommands</group>
    </rule>

    <rule id="107015" level="14">
        <if_sid>80792</if_sid>
        <field name="audit.type">SYSCALL</field>
        <regex>"\.*wmiexec\.*"</regex>
        <description>Possible malicious command executed (wmiexec.py).</description>
        <group>maliciouscommands</group>
    </rule>

    <rule id="107016" level="14">
        <if_sid>80792</if_sid>
        <field name="audit.type">SYSCALL</field>
        <regex>"\.*getArch\.*"</regex>
        <description>Possible malicious command executed (getArch.py).</description>
        <group>maliciouscommands</group>
    </rule>

    <rule id="107017" level="14">
        <if_sid>80792</if_sid>
        <field name="audit.type">SYSCALL</field>
        <regex>"\.*lookupsid\.*"</regex>
        <description>Possible malicious command executed (lookupsid.py).</description>
        <group>maliciouscommands</group>
    </rule>

    <rule id="107018" level="14">
        <if_sid>80792</if_sid>
        <field name="audit.type">SYSCALL</field>
        <regex>"\.*smbclient\.*"</regex>
        <description>Possible malicious command executed (smbclient.py).</description>
        <group>maliciouscommands</group>
    </rule>

    <rule id="107019" level="14">
        <if_sid>80792</if_sid>
        <field name="audit.type">SYSCALL</field>
        <regex>"\.*LinEnum.sh\.*"</regex>
        <description>Possible malicious command executed (LinEnum.sh).</description>
        <group>maliciouscommands</group>
    </rule>

    <rule id="107020" level="14">
        <if_sid>80792</if_sid>
        <field name="audit.type">SYSCALL</field>
        <regex>"\.*linux-exploit-suggester\.*"</regex>
        <description>Possible malicious command executed (linux-exploit-suggester.sh).</description>
        <group>maliciouscommands</group>
    </rule>

    <rule id="107021" level="14">
        <if_sid>80792</if_sid>
        <field name="audit.type">SYSCALL</field>
        <regex>"\.*linuxprivchecker\.*"</regex>
        <description>Possible malicious command executed (linuxprivchecker.py).</description>
        <group>maliciouscommands</group>
    </rule>

    <rule id="107022" level="14">
        <if_sid>80792</if_sid>
        <field name="audit.type">SYSCALL</field>
        <regex>"\.*sherlock.py\.*"</regex>
        <description>Possible malicious command executed (sherlock.py).</description>
        <group>maliciouscommands</group>
    </rule>

    <rule id="107023" level="14">
        <if_sid>80792</if_sid>
        <field name="audit.type">SYSCALL</field>
        <regex>"\.*responder\.*"</regex>
        <description>Possible malicious command executed (Responder).</description>
        <group>maliciouscommands</group>
    </rule>

    <rule id="107024" level="14">
        <if_sid>80792</if_sid>
        <field name="audit.type">SYSCALL</field>
        <regex>"\.*psexec\.*"</regex>
        <description>Possible malicious command executed (psexec.py).</description>
        <group>maliciouscommands</group>
    </rule>

    <rule id="107025" level="14">
        <if_sid>80792</if_sid>
        <field name="audit.type">SYSCALL</field>
        <regex>"\.*nikto\.*"</regex>
        <description>Possible malicious command executed (nikto).</description>
        <group>maliciouscommands</group>
    </rule>

    <rule id="107026" level="14">
        <if_sid>80792</if_sid>
        <field name="audit.type">SYSCALL</field>
        <regex>"\.*dirb\.*"</regex>
        <description>Possible malicious command executed (dirb).</description>
        <group>maliciouscommands</group>
    </rule>

    <rule id="107027" level="14">
        <if_sid>80792</if_sid>
        <field name="audit.type">SYSCALL</field>
        <regex>"\.*enum4linux\.*"</regex>
        <description>Possible malicious command executed (enum4linux).</description>
        <group>maliciouscommands</group>
    </rule>

    <rule id="107028" level="14">
        <if_sid>80792</if_sid>
        <field name="audit.type">SYSCALL</field>
        <regex>"\.*lazagne\.*"</regex>
        <description>Possible malicious command executed (lazagne).</description>
        <group>maliciouscommands</group>
    </rule>

    <rule id="107029" level="14">
        <if_sid>80792</if_sid>
        <field name="audit.type">SYSCALL</field>
        <regex>"\.*mimikatz\.*"</regex>
        <description>Possible malicious command executed (mimikatz).</description>
        <group>maliciouscommands</group>
    </rule>

    <rule id="107030" level="14">
        <if_sid>80792</if_sid>
        <field name="audit.type">SYSCALL</field>
        <regex>"\.*ncrack\.*"</regex>
        <description>Possible malicious command executed (ncrack).</description>
        <group>maliciouscommands</group>
    </rule>

    <rule id="107031" level="14">
        <if_sid>80792</if_sid>
        <field name="audit.type">SYSCALL</field>
        <regex>"\.*bloodhound\.*"</regex>
        <description>Possible malicious command executed (bloodhound).</description>
        <group>maliciouscommands</group>
    </rule>

    <rule id="107032" level="14">
        <if_sid>80792</if_sid>
        <field name="audit.type">SYSCALL</field>
        <regex>"\.*sqlninja\.*"</regex>
        <description>Possible malicious command executed (sqlninja).</description>
        <group>maliciouscommands</group>
    </rule>

    <rule id="107033" level="14">
        <if_sid>80792</if_sid>
        <field name="audit.type">SYSCALL</field>
        <regex>"\.*volatility\.*"</regex>
        <description>Possible malicious command executed (volatility).</description>
        <group>maliciouscommands</group>
    </rule>

    <!-- <rule id="107034" level="14">
        <if_sid>80792</if_sid>
        <field name="audit.type">SYSCALL</field>
        <regex>"\.*pspy\.*"</regex>
        <description>Possible malicious command executed (pspy).</description>
        <group>maliciouscommands</group>
    </rule> -->

    <rule id="107035" level="14">
        <if_sid>80792</if_sid>
        <field name="audit.type">SYSCALL</field>
        <regex>"\.*sublist3r\.*"</regex>
        <description>Possible malicious command executed (sublist3r).</description>
        <group>maliciouscommands</group>
    </rule>

    <rule id="107036" level="14">
        <if_sid>80792</if_sid>
        <field name="audit.type">SYSCALL</field>
        <regex>"\.*amass\.*"</regex>
        <description>Possible malicious command executed (amass).</description>
        <group>maliciouscommands</group>
    </rule>

    <rule id="107037" level="14">
        <if_sid>80792</if_sid>
        <field name="audit.type">SYSCALL</field>
        <regex>"\.*fierce\.*"</regex>
        <description>Possible malicious command executed (fierce).</description>
        <group>maliciouscommands</group>
    </rule>

    <rule id="107038" level="14">
        <if_sid>80792</if_sid>
        <field name="audit.type">SYSCALL</field>
        <regex>"\.*w3af\.*"</regex>
        <description>Possible malicious command executed (w3af).</description>
        <group>maliciouscommands</group>
    </rule>

    <rule id="107039" level="14">
        <if_sid>80792</if_sid>
        <field name="audit.type">SYSCALL</field>
        <regex>"\.*knock\.*"</regex>
        <description>Possible malicious command executed (knock).</description>
        <group>maliciouscommands</group>
    </rule>

    <rule id="107040" level="14">
        <if_sid>80792</if_sid>
        <field name="audit.type">SYSCALL</field>
        <regex>"\.*hashcat\.*"</regex>
        <description>Possible malicious command executed (hashcat).</description>
        <group>maliciouscommands</group>
    </rule>

    <!--
     <rule id="107041" level="14"><if_sid>80792</if_sid><field name="audit.type">SYSCALL</field>
     <regex>"\.*jtr\.*"</regex><description>Possible malicious command executed (jtr).</description><group>maliciouscommands</group></rule>
     -->

    <rule id="107042" level="14">
        <if_sid>80792</if_sid>
        <field name="audit.type">SYSCALL</field>
        <regex>"\.*hydra\.*"</regex>
        <description>Possible malicious command executed (hydra).</description>
        <group>maliciouscommands</group>
    </rule>

    <rule id="107043" level="14">
        <if_sid>80792</if_sid>
        <field name="audit.type">SYSCALL</field>
        <regex>"\.*medusa\.*"</regex>
        <description>Possible malicious command executed (medusa).</description>
        <group>maliciouscommands</group>
    </rule>

    <!-- plantear modificacion al grupo -->

    <rule id="107044" level="14">
        <if_sid>80792</if_sid>
        <field name="audit.type">SYSCALL</field>
        <regex>a\d+="john"</regex>
        <description>Possible malicious command executed (john).</description>
        <group>maliciouscommands</group>
    </rule>

    <rule id="107045" level="14">
        <if_sid>80792</if_sid>
        <field name="audit.type">SYSCALL</field>
        <regex>"\.*nosqlmap\.*"</regex>
        <description>Possible malicious command executed (nosqlmap).</description>
        <group>maliciouscommands</group>
    </rule>

    <rule id="107046" level="14">
        <if_sid>80792</if_sid>
        <field name="audit.type">SYSCALL</field>
        <regex>"\.*msfconsole\.*"</regex>
        <description>Possible malicious command executed (msfconsole).</description>
        <group>maliciouscommands</group>
    </rule>

    <rule id="107047" level="14">
        <if_sid>80792</if_sid>
        <field name="audit.type">SYSCALL</field>
        <regex>"\.*wfuzz\.*"</regex>
        <description>Possible malicious command executed (wfuzz).</description>
        <group>maliciouscommands</group>
    </rule>

    <!-- FIN DE REGLAS SIN PARAMETROS  -->

    <!-- ESCALACION DE PRIVILEGIOS  -->

    <rule id="107049" level="14">
        <if_sid>80792</if_sid>
        <field name="audit.type">SYSCALL</field>
        <regex>"\.*sudo\.*strace\.*-o\.*|\.*sudo\.*strace\.*/bin/bash\.*|\.*sudo\.*strace\.*/bin/sh\.*|\.*sudo\.*strace\.*/bin/dash\.*"</regex>
        <description>Possible malicious command executed (strace + shell).</description>
        <group>maliciouscommands</group>
    </rule>

    <rule id="107050" level="14">
        <if_sid>80792</if_sid>
        <field name="audit.type">SYSCALL</field>
        <regex>"\.*sudo\.*find\.*-exec\.*/bin/bash\.*|\.*sudo\.*find\.*-exec\.*/bin/dash\.*|\.*sudo\.*find\.*-exec\.*/bin/sh\.*"</regex>
        <description>Possible malicious command executed (find + shell).</description>
        <group>maliciouscommands</group>
    </rule>

    <rule id="107051" level="14">
        <if_sid>80792</if_sid>
        <field name="audit.type">SYSCALL</field>
        <regex>\.*service\.*../../\.*</regex>
        <description>Possible malicious command executed (service + shell).</description>
        <group>maliciouscommands</group>
    </rule>

    <rule id="107052" level="14">
        <if_sid>80792</if_sid>
        <field name="audit.type">SYSCALL</field>
        <regex>"\.*sudo\.*nmap\.*--script\.*|\.*sudo\.*nmap\.*--interactive\.*"</regex>
        <description>Possible malicious command executed (nmap + shell).</description>
        <group>maliciouscommands</group>
    </rule>

    <rule id="107053" level="14">
        <if_sid>80792</if_sid>
        <field name="audit.type">SYSCALL</field>
        <regex>"\.*sudo\.*tcpdump\.*-z\.*"</regex>
        <description>Possible malicious command executed (tcpdump -z + shell ).</description>
        <group>maliciouscommands</group>
    </rule>

    <rule id="107056" level="14">
        <if_sid>80792</if_sid>
        <field name="audit.type">SYSCALL</field>
        <regex>"\.*secretsdump\.*"</regex>
        <description>Possible malicious command executed (secretsdump).</description>
        <group>maliciouscommands</group>
    </rule>

    <rule id="107057" level="14">
        <if_sid>80792</if_sid>
        <field name="audit.type">SYSCALL</field>
        <regex>"\.*os_ident\.*"</regex>
        <description>Possible malicious command executed (os_ident).</description>
        <group>maliciouscommands</group>
    </rule>

    <rule id="107058" level="14">
        <if_sid>80792</if_sid>
        <field name="audit.type">SYSCALL</field>
        <regex>"\.*serviceinstall.py\.*"</regex>
        <description>Possible malicious command executed (serviceinstall.py).</description>
        <group>maliciouscommands</group>
    </rule>

    <rule id="107059" level="14">
        <if_sid>80792</if_sid>
        <field name="audit.type">SYSCALL</field>
        <regex>"\.*remcomsvc\.*"</regex>
        <description>Possible malicious command executed (remcomsvc).</description>
        <group>maliciouscommands</group>
    </rule>

    <!-- FIN ESCALACION DE PRIVILEGIOS  -->

    <!-- POSIBLE REVERSE SHELL  -->

    <rule id="107054" level="14">
        <if_sid>80792</if_sid>
        <field name="audit.type">SYSCALL</field>
        <regex>"\.*mknod\.*"</regex>
        <description>Possible malicious command executed (mknod).</description>
        <group>maliciouscommands</group>
    </rule>

    <rule id="107055" level="10">
        <if_sid>106003</if_sid>
        <field name="audit.real_user">root</field>
        <!-- <list field="srcip" lookup="not_address_match_key">etc/lists/allowedRootLoginIps</list> -->
        <srcip>!10.12.13.75</srcip>
        <srcip>!10.70.0.5</srcip>
        <srcip>!10.70.0.6</srcip>
        <srcip>!10.12.5.160</srcip>
        <srcip>!10.12.12.207</srcip>
        <srcip>!10.172.23.113</srcip>
        <srcip>!10.1.5.48</srcip>
        <srcip>!10.1.5.49</srcip>
        <srcip>!10.1.5.50</srcip>
        <srcip>!10.1.5.51</srcip>
        <srcip>!10.70.135.71</srcip>
        <srcip>!10.12.10.207</srcip>
        <description>Critical ssh login with master key</description>
    </rule>

    <rule id="107060" level="10" frequency="8" timeframe="120" ignore="60">                                                                                     
        <if_matched_sid>106002</if_matched_sid>                                                                                                                 
        <description>sshd: brute force trying to get access to </description>                                                                                   
        <description>the system.</description>                                  
        <same_source_ip />                                                                                                                                      
        <group>authentication_failures,pci_dss_11.4,pci_dss_10.2.4,pci_dss_10.2.5,gdpr_IV_35.7.d,gdpr_IV_32.2,hipaa_164.312.b,nist_800_53_SI.4,nist_800_53_AU.14,nist_800_53_AC.7,</group>
    </rule>

    <!-- Esta abominacion se tuvo que hacer porque el new group tmb matchea cuando se usa el useradd y no el groupadd, con lo cual no matcheaba el dstuser por el decoder,y no podiamos aplicar listas -->

    <rule id="107061" level="10">
        <program_name>groupadd</program_name>
        <match>^new group</match>
        <description>New group (critical) added to the system.</description>
        <group>pci_dss_10.2.7,pci_dss_10.2.5,pci_dss_8.1.2,gpg13_4.13,gdpr_IV_35.7.d,gdpr_IV_32.2,hipaa_164.312.b,hipaa_164.312.a.2.I,hipaa_164.312.a.2.II,nist_800_53_AU.14,nist_800_53_AC.7,nist_800_53_AC.2,nist_800_53_IA.4,</group>
    </rule>

    <rule id="105010" level="9">
        <if_sid>107061</if_sid>
        <list field="user" lookup="match_key">etc/lists/serviceAndSysadminAccounts</list>
        <description>New group (known) added to the system</description>
        <group>pci_dss_10.2.7,pci_dss_10.2.5,pci_dss_8.1.2,gpg13_4.13,gdpr_IV_35.7.d,gdpr_IV_32.2,</group>
    </rule>

    <rule id="106004" level="9">
        <match>^new group</match>
        <description>New group added to the system with useradd instead of groupadd (program name groupadd not found).</description>
        <group>pci_dss_10.2.7,pci_dss_10.2.5,pci_dss_8.1.2,gpg13_4.13,gdpr_IV_35.7.d,gdpr_IV_32.2,hipaa_164.312.b,hipaa_164.312.a.2.I,hipaa_164.312.a.2.II,nist_800_53_AU.14,nist_800_53_AC.7,nist_800_53_AC.2,nist_800_53_IA.4,</group>
    </rule>


    <rule id="106012" level="15">
        <hostname>sec-test|soc-test</hostname>
        <if_group>maliciouscommands</if_group>
        <description>Malicious command from whitelisted ip.</description>
    </rule>

    <!-- FIN REVERSE SHELL  -->

    <!-- Linux custom section -->

    <!-- Rule ID between 108000 and 108999 -->

    <!-- Automated tests -->

    <rule id="108001" level="9">
        <if_sid>5710</if_sid>
        <user>soc-automated-test</user>
        <description>[AUTOMATED-TEST] SSH</description>
    </rule>

    <rule id="108002" level="9">
        <if_sid>80792</if_sid>
        <field name="audit.command">bash</field>
        <match>a2="soc-automated-test"</match>
        <description>[AUTOMATED-TEST] Auditd</description>
    </rule>

    <!-- Fin Automated tests -->

    <!-- Matchea alarmas de medusa en los cluster de empacar (hay una aplicacion con ese nombre y va a tirar falsos positivos)-->

    <rule id="108003" level="0">
        <if_sid>107043</if_sid>
        <hostname>medusa-|empacar-</hostname>
        <field name="audit.type">SYSCALL</field>
        <description>Ignored rule for empacar cluster (malicious binary matches application name with false positives)</description>
        <group>attacks,</group>
    </rule>

    <rule id="108004" level="7">
        <if_sid>5501</if_sid>
        <list field="user" lookup="match_key">etc/lists/ignoredLoginUsers</list>
        <!-- <user>despegar|munin-async|masterchef|logger|cloudcli|sox|device42|dbmanager|root|newrelic|nova</user> -->
        <description>PAM: Login session opened</description>
        <group>pci_dss_10.2.7,pci_dss_10.2.5,pci_dss_8.1.2,gpg13_4.13,gdpr_IV_35.7.d,gdpr_IV_32.2,</group>
    </rule>


</group>

<!-- rule.id: 60204 AND data.win.eventdata.targetUserName: * -->

<!-- Ossec agent disconnected.
Auditd: End
Ossec agent removed. -->
